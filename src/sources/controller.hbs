/* eslint-disable */
// @ts-nocheck

import { Controller, UseGuards, UseInterceptors } from "@nestjs/common";
import { {{SourceNamePascal}} } from "./sources/{{SourceName}}";
import { Controller, Get, Query, UseGuards, UseInterceptors } from "@nestjs/common";
import { SourceType, AccountCredentialType } from "@prisma/client";
import { AccountService } from "./account/account.service";
import { ApiQuery, ApiResponse, ApiTags } from '@nestjs/swagger';
import { AccountService } from "./account/account.service";
import axios from "axios";

@Controller("{{SourceName}}")
@UseInterceptors(ClientPolicyCheck, UserPolicyCheck, TrackUsage)
@ApiTags("sources")
@UseGuards(AuthGuard("custom"))
export class {{SourceNamePascal}}Controller {
  source: {{SourceNamePascal}};
  constructor(private accountService: AccountService) {
    this.source = new {{SourceNamePascal}}();
  }
  {{#each resources}}
  @Get("{{ResourceName}}")
  @ApiQuery({{{ResourceInputSchema}}})
  @ApiResponse({{{ResourceOutputSchema}}})
  {{ResourceName}}(@Query() query, @AuthenticatedClient() httpClient): Promise<any> {
    const resource = this.source.resources["{{ResourceName}}"]
    const action = resource.getAction();
    return action(httpClient, query);
  }
  {{/each}}

  
  @Get("authUrl")
  @ApiQuery("")
  getAuthUrl(@ClientCredentials() credentials, @Query() query): string {
    const { connectionRequestId } = query;
    const callbackUrl = `${process.env.API_URL}/{{SourceName}}/callback`;
    return this.source.getAuthUrl(connectionRequestId, credentials.clientId, callbackUrl);
  }

  @Get("callback")
  async getAuthCallback(@Request() request, @CurrentAccount()): Promise<void> {
    const {credentials, state} = await this.source.handleAuthCallback(axios, request);
    await this.accountService.create(SourceType.{{SourceName}}, state, AccountCredentialType.{{AccessType}}, credentials); // the state is the connectionRequestId
    return {};
  }
}
